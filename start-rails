#!/bin/bash --login

HOME=/services/medusa
MEDUSA_HOME=$HOME/medusa
export RAILS_ENV=production

if [ -f $HOME/.delayed_job_web_credentials ]; then
    source $HOME/.delayed_job_web_credentials
fi

#Clear Rails cache
( cd $MEDUSA_HOME ; bundle exec rake medusa:rails_cache:clear )

ionice -c2 -n1 -p $$
# Start Passenger
( cd $MEDUSA_HOME ; bundle install ; bundle exec passenger start -e production -d --max-pool-size 20 )

#Start daemon to pick up incoming messages
#Use this script because cron may already have started it
#while delayed job was starting
$HOME/bin/check-message-receiver-daemon

exit 0
